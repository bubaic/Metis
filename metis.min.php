<?php
class Metis{public $nodeList = "";	public $directoryHostingMetis = "";function __construct(){$returnedNodeListData = $this->metisInit();	$this->nodeList = $returnedNodeListData[0];$this->directoryHostingMetis = $returnedNodeListData[1];}
function fileHashing($t){$A=str_replace(" ","",atlasui_string_clean($t,1,true));$CB=atlasui_hashing($A,100000,substr($A,0,10));return substr($CB,1,28);}function navigateToLocalMetisData($K=null){$z=getcwd();if($this->directoryHostingMetis!==null){chdir($this->directoryHostingMetis);}chdir("Metis");chdir("data");if($K!==null){if(chdir($K)==false){return 2.01;}}return$z;}function backupQueuer(array$y,array$B,$C){$j=navigateToLocalMetisData("backup");$M=file_get_contents(fileHashing("backup-queue").".json");$o=md5($M);if(strlen(trim($M))>2){$H=$this->decodeJsonFile($M);}else{$H=array();}$W=array();foreach($y as$F=>$d){if($this->nodeList[$F]["Backup Data"]!==null){if($this->nodeList[$F]["Backup Data"]["Enabled"]==true){$W[]=$F;}}else{if(nodeInfo($F,"Node Type")=="group"){if(gettype($d)=="array"){$V=$d;}else{$V=nodeInfo($F,"group-nodes");}foreach($V as$Z){if($V[$Z]["Backup Data"]!==null){if($V[$Z]["Backup Data"]["Enabled"]==true){$W[]=$F."#".$Z;}}}}}if(count($W)>0){foreach($W as$J){if(gettype($H[$J])!=="array"){$H[$J]=array();}foreach($B as$A){if($H[$J][$A]!==null){$v=$H[$J][$A];$c=$v["action"];if($c!==$C){if((($c=="w")||($c=="a"))&&($C=="d")){$H[$J][$A]["action"]=$C;}}}else{$H[$J][$A]=array();$H[$J][$A]["action"]=$C;}}}}}$M=json_encode($H);$_=md5($M);if($o!==$_){$A=$this->fileHashing("backup-queue");$R=fopen($A.".json","w+");fwrite($R,$M);fclose($R);touch($A.".json");}chdir($j);}function fileIOArrayMerger(array$w){$O=array();foreach($w as$T){$u=array_keys($T);foreach($u as$A){if(is_null($O[$A])){$O[$A]=$T[$A];}elseif(is_int($O[$A])){if(is_array($T[$A])){$O[$A]=$T[$A];}}}}return$O;}function fileActionHandler($s,$B,$C,array$I=null){if($this->nodeList!==1.01){$G=array();$x=getcwd();$E=$this->nodeDataParser($s);if(gettype($B)=="string"){$B=(array)$B;$U=false;}else{if(count($B)==1){$U=false;}else{$U=true;}}foreach($E as$F=>$f){if(nodeInfo($F,"Node Type")=="group"){$e=true;if(gettype($f)=="array"){$X=$f;}else{$X=nodeInfo($F,"group-nodes");}}else{$e=false;$X=array($F);}foreach($X as$Y){if($e==true){$S=$this->nodeList[$F];}else{$S=$this->nodeList;}$BB=nodeInfo($Y,"Node Type",$S);$K=nodeInfo($Y,"Preferential Location",$S);if(($BB=="local")&&($K!=="backup")){$r=navigateToLocalMetisData($K);if($r!==2.01){foreach($B as$L){$A=$this->fileHashing($L);$D="";if(($C=="r")||($C=="a")){$D=file_get_contents($A.".json");if($D==false){$D=2.05;}else{$D=$this->decodeJsonFile($D);}}if(($C=="w")||($D!==2.05&&$C=="a")){if($C=="a"){$Q=array_replace_recursive($D,$I);}else{$Q=$I;}$Q=json_encode($Q);if($Q==false){$D=3.01;}else{$R=fopen($A.".json","w+");fwrite($R,$Q);fclose($R);touch($A.".json");$D="0.00";}}else if($C=="e"){$D=array("found"=>file_exists($A.".json"));}else if($C=="d"){if(unlink($A.".json")!==false){$D="0.00";}else{$D=4.01;}}if($U==true){$G=fileIOArrayMerger(array($G,array($L=>$D)));}else{if(($C=="r")&&($D!==1.05)){unset($B[$L]);}$G=$D;if($C=="r"){break 3;}}}chdir($x);}else{$G=2.01;}}else{$AB=nodeInfo($Y,"Node Type",$S);$P=array();$P["fileAction"]=$C;$P["nodeData"]=$K;$P["files"]=$B;if(is_null($I)==false){$P["contentOrDestinationNodes"]=$I;}$i=json_encode($P,true);$N=atlasui_http_request($AB."/callback.php","POST",$i);if($U==true){if(count($B)>1){$h=$this->decodeJsonFile($N);foreach($h as$A=>$l){if(gettype($l)=="array"){unset($B[$A]);}}$G=fileIOArrayMerger(array($G,$N));}else{$A=$B[0];if(strlen($N)!=="3"){unset($B[0]);}$G=fileIOArrayMerger(array($G,array($A=>$N)));}}else{$G=$N;}}}}if($C!=="r"){$DB=$this->backupQueuer($E,$B,$C);}return json_encode($G);}else{return 1.01;}}function decodeJsonFile($q){$a=json_decode($q,true);if($a==(false||NULL||null)){$a=2.06;}return$a;}function createJsonFile($E,$B,array$I){return fileActionHandler($E,$B,"w",$I);}function readJsonFile($E,$B){return fileActionHandler($E,$B,"r");}function updateJsonFile($E,$B,array$I,$n=true){if($n==false){$g="w";}else{$g="a";}return fileActionHandler($E,$B,$g,$I);}function deleteJsonFile($E,$B){return fileActionHandler($E,$B,"d");}function replicator($E,$p,$B){if($this->nodeList!==1.01){if(gettype($B)=="string"){$B=(array)$B;}foreach($B as$L){$b=$this->readJsonFile($E,array($L));if(gettype($b)=="string"){$m=$this->decodeJsonFile($b);foreach($p as$k){createJsonFile($k,array($L),$m);}}else{return$b;}}return"0.00";}else{return$this->nodeList;}}
function metisInit(){$R=$_SERVER['DOCUMENT_ROOT'];$L=getcwd();$I=0;$H=null;$C=null;$G=false;$this->directoryHostingMetis="";while($I<6){if($C!==null){chdir($C);}$H=getcwd();if(is_dir("Metis")==true){$G=true;break;}else{if($H!==$_SERVER['DOCUMENT_ROOT']){if($C==null){$C="../";}else{$C=$C."../";}}else{$G=false;break;}}chdir($L);$I=$I+1;}if($G==true){chdir($R);$Q=getcwd();$S=str_replace($Q,"",$H);$this->directoryHostingMetis=str_replace("//","/",$Q.$S);chdir($this->directoryHostingMetis);$this->nodeList=$this->decodeJsonFile(file_get_contents("Metis/nodeList.json"));}else{$this->nodeList=1.01;}chdir($L);return array($this->nodeList,$this->directoryHostingMetis);}function nodeDataParser($D){$B=array();if(gettype($D)=="string"){if(strpos($D,"|")!==false){$N=explode("|",$D);}else{$N=array($D);}foreach($N as$F){if(strpos($F,"#")!==false){$P=explode("#",$F);$O=$P[0];$A=$P[1];if(strpos($A,",")!==false){$B[$O]=explode(",",$A);}else{$B[$O]=array($A);}}else{$B[$F]=null;}}}else if(gettype($B)=="array"){$B=$D;}else{$B[]=(array)$D;}return$B;}function nodeInfo($E,$M,$J=null){if($J==null){}else{$this->nodeList=$J;}if($this->nodeList[$E]!==null){if($M!=="group-nodes"){$K=$this->nodeList[$E][$M];if(isset($K)){return$K;}else{return 1.03;}}else{$A=array_keys($this->nodeList[$E]);$A=array_values(array_diff($A,array("Backup Data","Node Type")));return$A;}}else{die($E." is not defined in nodeList.");}}
function fileExists($N,$Q){return fileActionHandler($N,$Q,"e");}function mysqlToMetis($H,$I,array$C){if(is_object($H)){if($this->nodeList!==1.01){if($this->nodeList[$I]!==null){$O=$C["debug"];$K=$C["filePrefix"];$P=$C["includePrimaryFieldInFile"];$D=$C["table"];$A=$C["primaryField"];if(is_string($D)==true){$R=mysqli_query($H,"SHOW COLUMNS FROM ".$D);$S=mysqli_query($H,"SELECT * FROM ".$D);$G=array();while($M=mysqli_fetch_array($R)){$G[]=$M[0];}if($A==null){$A=$G[0];}while($F=mysqli_fetch_array($S)){$J=array();if($K!==null){$B=$K;}else{$B=$D;}$B=$B."_".$F[$A];if($P==true){$J[$A]=$F[$A];}foreach($G as$E){if($E!==$A){$J[$E]=$F[$E];}}$L=$this->createJsonFile($I,array($B),$J);if($O==true){print"We attempted to create ".$B." on Node #".$I." and received the following response: ".$L."<br />";}}return"0.00";}else{return 5.01;}}else{return 1.02;}}else{return 1.01;}}else{return 1.06;}}}