<?php
class Metis{var$nodeList="";var$directoryHostingMetis="";function __construct(){$EB=$this->metisInit();$this->nodeList=$EB[0];$this->directoryHostingMetis=$EB[1];}function fileHashing($RB){$A=preg_replace('/[^a-z0-9]/',"",$RB);$PB=substr($A,0,10);$NB='$6$rounds=100000$'.$PB."$";$XB=strlen($NB);$OB=substr(str_replace(array("/","\"",'"'),"",crypt(sha1(md5($A)),$NB)),$XB);return substr($OB,1,28);}function navigateToLocalMetisData($N=null){$T=$this->directoryHostingMetis;$lB=getcwd();if($T!==null){chdir($T);}chdir("Metis");chdir("data");if($N!==null){if(is_dir($N)==false){mkdir($N);}chdir($N);}return$lB;}function backupQueuer(array$YB,array$B,$E){$D=$this->nodeList;$ZB=$this->navigateToLocalMetisData("backup");$S=file_get_contents($this->fileHashing("backup-queue").".json");$dB=md5($S);if(strlen(trim($S))>2){$L=$this->decodeJsonFile($S);}else{$L=array();}$i=array();foreach($YB as$J=>$FB){if(isset($D[$J]["Backup Data"])){if($D[$J]["Backup Data"]["Enabled"]==true){$i[]=$J;}}else{if($this->nodeInfo($J,"Node Type")=="group"){if(gettype($FB)=="array"){$I=$FB;}else{$I=$this->nodeInfo($J,"group-nodes");}foreach($I as$r){if(isset($I[$r]["Backup Data"])){if($I[$r]["Backup Data"]["Enabled"]==true){$i[]=$J."#".$r;}}}}}if(count($i)>0){foreach($i as$O){if(gettype($L[$O])!=="array"){$L[$O]=array();}foreach($B as$A){if(isset($L[$O][$A])){$hB=$L[$O][$A];$y=$hB["action"];if($y!==$E){if((($y=="w")||($y=="a"))&&($E=="d")){$L[$O][$A]["action"]=$E;}}}else{$L[$O][$A]=array();$L[$O][$A]["action"]=$E;}}}}}$S=json_encode($L);$gB=md5($S);if($dB!==$gB){$A=$this->fileHashing("backup-queue");$W=fopen($A.".json","w+");fwrite($W,$S);fclose($W);touch($A.".json");}chdir($ZB);}function fileIOArrayMerger(array$fB){$V=array();foreach($fB as$j){$qB=array_keys($j);foreach($qB as$A){if(is_null($V[$A])){$V[$A]=$j[$A];}elseif(is_int($V[$A])){if(is_array($j[$A])){$V[$A]=$j[$A];}}}}return$V;}function fileActionHandler($H,$B,$E,array$M=null){$D=$this->nodeList;if($D!==1.01){$K=array();$b=getcwd();$C=$this->nodeDataParser($H);if(gettype($B)=="string"){$B=(array)$B;$e=false;}else{if(count($B)==1){$e=false;}else{$e=true;}}foreach($C as$J=>$IB){if($this->nodeInfo($J,"Node Type")=="group"){$HB=true;if(gettype($IB)=="array"){$v=$IB;}else{$v=$this->nodeInfo($J,"group-nodes");}}else{$HB=false;$v=array($J);}foreach($v as$P){if($HB==true){$g=$D[$J];}else{$g=$D;}$iB=$this->nodeInfo($P,"Node Type",$g);$N=$this->nodeInfo($P,"Preferential Location",$g);if(($iB=="local")&&($N!=="backup")){$eB=$this->navigateToLocalMetisData($N);if($eB!==2.01){foreach($B as$Q){$A=$this->fileHashing($Q);$F="";if(($E=="r")||($E=="a")){$F=file_get_contents($A.".json");if($F==false){$F=2.05;}else{$F=$this->decodeJsonFile($F);}}if(($E=="w")||($F!==2.05&&$E=="a")){if($E=="a"){$a=array_replace_recursive($F,$M);}else{$a=$M;}$a=json_encode($a);if($a==false){$F=3.01;}else{$W=fopen($A.".json","w+");fwrite($W,$a);fclose($W);touch($A.".json");$F="0.00";}}else if($E=="e"){$F=array("found"=>file_exists($A.".json"));}else if($E=="d"){if(unlink($A.".json")!==false){$F="0.00";}else{$F=4.01;}}if($e==true){$K=$this->fileIOArrayMerger(array($K,array($Q=>$F)));}else{if(($E=="r")&&($F!==1.05)){unset($B[$Q]);}$K=$F;if($E=="r"){break 3;}}}chdir($b);}else{$K=2.01;}}else{$k=$this->nodeInfo($P,"Address",$g);$X=array();$X["fileAction"]=$E;$X["nodeData"]=$N;$X["files"]=$B;if(is_null($M)==false){$X["contentOrDestinationNodes"]=$M;}$h=json_encode($X,true);$KB=$this->http_request($k,$h);$f=$this->decodeJsonFile($KB);if($e==true){if(count($B)>1){foreach($f as$A=>$aB){if(gettype($aB)=="array"){unset($B[$A]);}}$K=$this->fileIOArrayMerger(array($K,$f));}else{$A=$B[0];if(strlen($KB)!=="3"){unset($B[0]);}$K=$this->fileIOArrayMerger(array($K,array($A=>$f)));}}else{$K=$f;}}}}if($E!=="r"){$vB=$this->backupQueuer($C,$B,$E);}return json_encode($K);}else{return 1.01;}}function createJsonFile($C,$B,array$M){return$this->fileActionHandler($C,$B,"w",$M);}function decodeJsonFile($bB){$o=json_decode($bB,true);if($o==(false||NULL||null)){$o=2.06;}return$o;}function fileExists($H,$B){return$this->fileActionHandler($H,$B,"e");}function readJsonFile($C,$B){return$this->fileActionHandler($C,$B,"r");}function updateJsonFile($C,$B,array$M,$cB=true){if($cB==false){$_="w";}else{$_="a";}return$this->fileActionHandler($C,$B,$_,$M);}function deleteJsonFile($C,$B){return$this->fileActionHandler($C,$B,"d");}function replicator($H,$kB,$B){if(gettype($B)=="string"){$B=(array)$B;}foreach($B as$Q){$p=$this->readJsonFile($H,array($Q));if(gettype($p)=="string"){$rB=$this->decodeJsonFile($p);foreach($kB as$tB){$uB=$this->createJsonFile($tB,array($Q),$rB);}}else{return$p;}}return"0.00";}function metisInit(){$sB=$_SERVER['DOCUMENT_ROOT'];$b=getcwd();$x=0;$w=null;$U=null;$m=false;$T="";while($x<6){if($U!==null){chdir($U);}$w=getcwd();if(is_dir("Metis")==true){$m=true;break;}else{if($w!==$_SERVER['DOCUMENT_ROOT']){if($U==null){$U="../";}else{$U=$U."../";}}else{$m=false;break;}}chdir($b);$x=$x+1;}if($m==true){chdir($sB);$CB=getcwd();$pB=str_replace($CB,"",$w);$T=str_replace("//","/",$CB.$pB);chdir($T);$D=$this->decodeJsonFile(file_get_contents("Metis/nodeList.json"));}else{$D=1.01;}chdir($b);return array($D,$T);}function http_request($k,$h){$G=curl_init();curl_setopt($G,CURLOPT_CUSTOMREQUEST,"POST");curl_setopt($G,CURLOPT_CONNECTTIMEOUT,15);curl_setopt($G,CURLOPT_FAILONERROR,true);curl_setopt($G,CURLOPT_FOLLOWLOCATION,false);curl_setopt($G,CURLOPT_MAXREDIRS,1);curl_setopt($G,CURLOPT_RETURNTRANSFER,true);curl_setopt($G,CURLOPT_SSL_VERIFYPEER,false);$mB=array("Content-length: ".strlen($h));curl_setopt($G,CURLOPT_HTTPHEADER,$mB);curl_setopt($G,CURLOPT_URL,$k."/callback.php");curl_setopt($G,CURLOPT_POSTFIELDS,$h);$nB=curl_exec($G);$JB=curl_error($G);curl_close($G);if($JB==0){return$nB;}else{$oB=array("3"=>"URL_MALFORMAT","7"=>"COULDNT_CONNECT","18"=>"PARTIAL_FILE","47"=>"TOO_MANY_REDIRECTS","63"=>"FILESIZE_EXCEEDED","67"=>"LOGIN_DENIED");$jB=settype($JB,"string");return$oB[$jB];}}function nodeDataParser($H){$C=array();if(gettype($H)=="string"){if(strpos($H,"|")!==false){$LB=explode("|",$H);}else{$LB=array($H);}foreach($LB as$u){if(strpos($u,"#")!==false){$GB=explode("#",$u);$MB=$GB[0];$I=$GB[1];if(strpos($I,",")!==false){$C[$MB]=explode(",",$I);}else{$C[$MB]=array($I);}}else{$C[$u]=null;}}}else if(gettype($C)=="array"){$C=$H;}else{$C[]=(array)$H;}return$C;}function nodeInfo($d,$z,$BB=null){if($BB==null){$D=$this->nodeList;}else{$D=$BB;}if($D[$d]!==null){if($z!=="group-nodes"){$AB=$D[$d][$z];if(isset($AB)){return$AB;}else{return 1.03;}}else{$I=array_keys($D[$d]);$I=array_values(array_diff($I,array("Backup Data","Node Type")));return$I;}}else{die($d." is not defined in nodeList.");}}function mysqlToMetis($l,$P,array$Y){$D=$this->nodeList;if(is_object($l)){if($D!==1.01){if($D[$P]!==null){$VB=$Y["debug"];$DB=$Y["filePrefix"];$WB=$Y["includePrimaryFieldInFile"];$c=$Y["table"];$R=$Y["primaryField"];if(is_string($c)==true){$UB=mysqli_query($l,"SHOW COLUMNS FROM ".$c);$TB=mysqli_query($l,"SELECT * FROM ".$c);$n=array();while($QB=mysqli_fetch_array($UB)){$n[]=$QB[0];}if($R==null){$R=$n[0];}while($q=mysqli_fetch_array($TB)){$s=array();if($DB!==null){$Z=$DB;}else{$Z=$c;}$Z=$Z."_".$q[$R];if($WB==true){$s[$R]=$q[$R];}foreach($n as$t){if($t!==$R){$s[$t]=$q[$t];}}$SB=$this->createJsonFile($P,array($Z),$s);if($VB==true){print"We attempted to create ".$Z." on Node #".$P." and received the following response: ".$SB."<br />";}}return"0.00";}else{return 5.01;}}else{return 1.02;}}else{return 1.01;}}else{return 1.06;}}}