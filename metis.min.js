var Metis=function(){function e(e,t,i){this.ioQueue=new Object,this.metisCallbackLocation=e,this.enableLocalStorage=void 0!==t?t:!1,this.userOnline=void 0==i?!0:!1}return e.prototype.init=function(){document.addEventListener("online",this.processIOQueue,!1),document.addEventListener("offline",this.toggleOfflineStatus,!1)},e.prototype.objectMerge=function(e,t){for(var i in t)e[i]=t[i].constructor==Object?void 0!==e[i]?this.objectMerge(e[i],t[i]):t[i]:t[i];return e},e.prototype.toggleOfflineStatus=function(){this.userOnline=!1},e.prototype.processIOQueue=function(){Object.getOwnPropertyNames(this.ioQueue);this.userOnline=!0;e:for(var e in this.ioQueue)for(var t in this.ioQueue[e]){var i=this.ioQueue[e][t].action,n=this.ioQueue[e][t].contentOrDestinationNodes;if(1!=this.userOnline)break e;this.fileActionHandler(e,[t],i,n),this.ioQueue[e][t]=null}},e.prototype.fileActionHandler=function(e,t,i,n){function o(){4==O.readyState&&(d=200==O.status?O.responseText:"HTTP ERROR CODE: "+O.status)}var r=new Object,s=[];if(1==this.enableLocalStorage)for(var l=0;l<t.length;l++){var a=t[l],u=e+"#"+a,c=new Object;if("r"==i&&(c=this.decodeJsonFile(localStorage.getItem(u))),"r"==i)null!==c?1==t.length?r=c:r[a]=c:s.push(a);else if("w"==i)localStorage.setItem(u,JSON.stringify(n));else if("a"==i){var f=JSON.stringify(this.objectMerge(c,n));localStorage.setItem(u,f)}else"d"==i&&localStorage.removeItem(u)}else s=t;if(1==this.userOnline){if("r"==i&&s.length>0||"r"!==i){var h={};h.fileAction=i,h.nodeNum=e,h.files="r"==i?s:t,void 0!==n&&(h.contentOrDestinationNodes=n);var d,p=JSON.stringify(h),O=new XMLHttpRequest;if(O.onreadystatechange=o,O.open("POST",this.metisCallbackLocation,!1),O.send(p),"r"==i&&-1==d.indexOf("HTTP ERROR CODE"))for(var g=this.decodeJsonFile(d),l=0;l<s.length;l++){var a=s[l];r[a]=1==s.length?g:g[a],1==this.enableLocalStorage&&(1==s.length?localStorage.setItem(e+"#"+a,JSON.stringify(g)):localStorage.setItem(e+"#"+a,JSON.stringify(g[a])))}else"r"!==i&&(r=g)}}else if("r"!==i&&(s=t),s.length>0)for(var l=0;l<s.length;l++){var a=s[l];0==this.ioQueue.hasOwnProperty(e)&&(this.ioQueue[e]=new Object),0==this.ioQueue[e].hasOwnProperty(a)&&(this.ioQueue[e][a]=new Object),this.ioQueue[e][a].action=i,"r"!==i&&(this.ioQueue[e][a].contentOrDestinationNodes=n)}return JSON.stringify(r)},e.prototype.decodeJsonFile=function(e){return JSON.parse(e)},e.prototype.readJsonFile=function(e,t){return this.fileActionHandler(e,t,"r")},e.prototype.createJsonFile=function(e,t,i){return this.fileActionHandler(e,t,"w",i)},e.prototype.updateJsonFile=function(e,t,i,n){return 0==n?this.fileActionHandler(e,t,"w",i):this.fileActionHandler(e,t,"a",i)},e.prototype.deleteJsonFile=function(e,t){return this.fileActionHandler(e,t,"d")},e.prototype.replicator=function(e,t,i){return this.fileActionHandler(e,i,"rp",t)},e}();
