var Metis=(function(){function a(d,e,c,b){if(d==true){this.enableHeadlessMetis=true;this.enableLocalStorage=true;this.userOnline=false}else{this.enableHeadlessMetis=false;if(e!==undefined){this.metisCallbackLocation=e;if(c!==undefined){this.enableLocalStorage=c}else{if(window.localStorage!==undefined){this.enableLocalStorage=true;if(this.fileExists("internal","ioQueue")!=="local"){this.createJsonFile("internal","ioQueue",{})}}else{this.enableLocalStorage=false}}}else{console.log("You have defined enableHeadlessMetisOption as FALSE but have NOT provided a callback URL. Expect errors.")}}if(b!==true){this.userOnline=true}else{this.userOnline=false}}a.prototype.init=function(){if(this.enableHeadlessMetis==false){document.addEventListener("online",this.processIOQueue,false);document.addEventListener("offline",this.toggleOfflineStatus,false)}};a.prototype.objectMerge=function(c,b){for(var d in b){if(typeof b[d]=="object"){if(c[d]!==undefined){c[d]=this.objectMerge(c[d],b[d])}else{c[d]=b[d]}}else{c[d]=b[d]}}return c};a.prototype.toggleOfflineStatus=function(){this.userOnline=false};a.prototype.addToIOQueue=function(c,b,d,j){var f=this.decodeJsonFile(this.readJsonFile("internal","ioQueue"));var l="";if(typeof c=="string"){l=c}else{if(typeof c=="object"){for(var i in c){var k=i;if(c[i]!==null){k=k+"#";var h=c[i];h.forEach(function(n,o,m){k=k+n;if(m.length!==(o+1)){k=k+","}else{k=k+"|"}});l=l+k}else{l=l+i+"|"}}l=l.slice(0,-1)}else{if(typeof c=="number"){l=c.toString()}}}if(typeof b=="string"){b=[b]}for(var e in b){var g=b[e];if(f.hasOwnProperty(g)==false){f[g]={}}if((f[g]["action"]=="w")&&(d=="d")){f[g]=null}else{f[g]["nodeData"]=l;f[g]["action"]=d;if(d==("w"||"a")){f[g]["contentOrDestinationNodes"]=j}else{if(f[g].hasOwnProperty("contentOrDestinationNodes")){f[g]["contentOrDestinationNodes"]=null}}}}this.updateJsonFile("internal","ioQueue",f,false)};a.prototype.processIOQueue=function(){var c=this.decodeJsonFile(this.readJsonFile("internal","ioQueue"));this.userOnline=true;for(var f in c){var b=c[f]["nodeData"];var d=c[f]["action"];var e=c[f]["contentOrDestinationNodes"];if(this.userOnline==true){this.fileActionHandler(b,f,d,e);c[f]=null}else{break}}this.updateJsonFile("internal","ioQueue",c,false)};a.prototype.fileActionHandler=function(p,d,e,m){var g={};var n=[];if(typeof d=="string"){d=[d]}if(this.enableLocalStorage==true){for(var f in d){var h=d[f];var l;if(e==("r"||"a")){l=localStorage.getItem(h)}if(e=="r"){if(l!==null){l=this.decodeJsonFile(l);if(d.length==1){g=l}else{g[h]=l}}else{n.push(h)}}else{if(e!=="e"){if(e=="w"){localStorage.setItem(h,JSON.stringify(m))}else{if(e=="a"){var c=JSON.stringify(this.objectMerge(l,m));localStorage.setItem(h,c)}else{if(e=="d"){localStorage.removeItem(h)}}}g[h]=this.decodeJsonFile('{"status" : "0.00"}')}else{if(localStorage.getItem(h)!==null){g[h]="local"}else{if(this.enableHeadlessMetis==true){g[h]=false}else{if((this.enableHeadlessMetis!==true)&&(p!=="internal")){n.push(h)}}}}}}}else{n=d}if(p!=="internal"){if(this.enableHeadlessMetis==false){if(this.userOnline==true){if((e=="r"&&n.length>0)||(e!=="r")){var i={};i.nodeData=p;if(e==("r"||"e")){i.files=n}else{i.files=d}i.fileAction=e;if(m!==(undefined||null)){i.contentOrDestinationNodes=m}var o=new XMLHttpRequest;var k="";function j(){if(o.readyState==4){if(o.status==200){k=o.responseText}else{k='{"error" : "HTTP ERROR CODE|'+o.status+'"}'}}}o.onreadystatechange=j;o.open("POST",this.metisCallbackLocation,false);o.send(JSON.stringify(i));var b=this.decodeJsonFile(k);for(var f in n){var h=n[f];if(n.length==1){g=b}else{g[h]=b[h]}if((e=="r")&&(this.enableLocalStorage==true)){if(n.length==1){localStorage.setItem(h,JSON.stringify(b))}else{localStorage.setItem(h,JSON.stringify(b[h]))}}}}}else{if(e!=="r"){n=d}if(n.length>0){this.addToIOQueue(p,n,e,m)}}}}return JSON.stringify(g)};a.prototype.decodeJsonFile=function(b){return JSON.parse(b)};a.prototype.readJsonFile=function(b,c){return this.fileActionHandler(b,c,"r")};a.prototype.createJsonFile=function(b,d,c){return this.fileActionHandler(b,d,"w",c)};a.prototype.updateJsonFile=function(b,d,c,e){if(e==(undefined||false)){return this.fileActionHandler(b,d,"w",c)}else{return this.fileActionHandler(b,d,"a",c)}};a.prototype.deleteJsonFile=function(b,c){return this.fileActionHandler(b,c,"d")};a.prototype.fileExists=function(b,c){return this.fileActionHandler(b,c,"e")};a.prototype.replicator=function(b,c,d){return this.fileActionHandler(b,d,"rp",c)};return a})();