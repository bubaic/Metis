var Metis=(function(){function a(d,e,c,b){this.ioQueue=new Object();if(d==true){this.enableHeadlessMetis=true;this.enableLocalStorage=true}else{this.enableHeadlessMetis=false;if(e!==undefined){this.metisCallbackLocation=e;if(c!==undefined){this.enableLocalStorage=c}else{this.enableLocalStorage=false}}else{console.log("You have defined enableHeadlessMetisOption as FALSE but have NOT provided a callback URL. Expect errors.")}}if(b==undefined||false){this.userOnline=true}else{this.userOnline=false}}a.prototype.init=function(){if(this.enableHeadlessMetis==false){document.addEventListener("online",this.processIOQueue,false);document.addEventListener("offline",this.toggleOfflineStatus,false)}};a.prototype.objectMerge=function(b,d){for(var c in d){if(d[c].constructor==Object){if(b[c]!==undefined){b[c]=this.objectMerge(b[c],d[c])}else{b[c]=d[c]}}else{b[c]=d[c]}}return b};a.prototype.toggleOfflineStatus=function(){this.userOnline=false};a.prototype.processIOQueue=function(){var c=Object.getOwnPropertyNames(this.ioQueue);this.userOnline=true;nodeRecursion:for(var b in this.ioQueue){for(var f in this.ioQueue[b]){var d=this.ioQueue[b][f]["action"];var e=this.ioQueue[b][f]["contentOrDestinationNodes"];if(this.userOnline==true){this.fileActionHandler(b,[f],d,e);this.ioQueue[b][f]=null}else{break nodeRecursion}}}};a.prototype.fileActionHandler=function(e,d,h,q){var k=new Object();var r=[];if(this.enableLocalStorage==true){for(var m=0;m<d.length;m++){var l=d[m];var s=e+"#"+l;var p=new Object();if(h==("r"||"a")){p=this.decodeJsonFile(localStorage.getItem(s))}if(h=="r"){if(p!==null){if(d.length==1){k=p}else{k[l]=p}}else{r.push(l)}}else{if(h=="w"){localStorage.setItem(s,JSON.stringify(q))}else{if(h=="a"){var c=JSON.stringify(this.objectMerge(p,q));localStorage.setItem(s,c)}else{if(h=="d"){localStorage.removeItem(s)}}}k[l]=this.decodeJsonFile('{"status" : "0.00"}')}}}else{r=d}if(this.enableHeadlessMetis==false){if(this.userOnline==true){if((h=="r"&&r.length>0)||(h!=="r")){var f={};f.fileAction=h;f.nodeNum=e;if(h=="r"){f.files=r}else{f.files=d}if(q!==undefined){f.contentOrDestinationNodes=q}var j=JSON.stringify(f);var o=new XMLHttpRequest();var n;function g(){if(o.readyState==4){if(o.status==200){n=o.responseText}else{n="HTTP ERROR CODE: "+o.status}}}o.onreadystatechange=g;o.open("POST",this.metisCallbackLocation,false);o.send(j);if(h=="r"&&n.indexOf("HTTP ERROR CODE")==-1){var b=this.decodeJsonFile(n);for(var m=0;m<r.length;m++){var l=r[m];if(r.length==1){k[l]=b}else{k[l]=b[l]}if(this.enableLocalStorage==true){if(r.length==1){localStorage.setItem(e+"#"+l,JSON.stringify(b))}else{localStorage.setItem(e+"#"+l,JSON.stringify(b[l]))}}}}else{if(h!=="r"){k=b}}}}else{if(h!=="r"){r=d}if(r.length>0){for(var m=0;m<r.length;m++){var l=r[m];if(this.ioQueue.hasOwnProperty(e)==false){this.ioQueue[e]=new Object()}if(this.ioQueue[e].hasOwnProperty(l)==false){this.ioQueue[e][l]=new Object()}this.ioQueue[e][l]["action"]=h;if(h!==("r"&&"d")){this.ioQueue[e][l]["contentOrDestinationNodes"]=q}}}}}return JSON.stringify(k)};a.prototype.decodeJsonFile=function(b){return JSON.parse(b)};a.prototype.readJsonFile=function(b,c){return this.fileActionHandler(b,c,"r")};a.prototype.createJsonFile=function(b,d,c){return this.fileActionHandler(b,d,"w",c)};a.prototype.updateJsonFile=function(b,d,c,e){if(e==(undefined||false)){return this.fileActionHandler(b,d,"w",c)}else{return this.fileActionHandler(b,d,"a",c)}};a.prototype.deleteJsonFile=function(b,c){return this.fileActionHandler(b,c,"d")};a.prototype.replicator=function(b,c,d){return this.fileActionHandler(b,d,"rp",c)};return a})();