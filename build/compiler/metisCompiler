#!/bin/bash

currentDirectory=$(pwd) # Get the current directory
currentDirectory=${currentDirectory%build*} #Remove the build folder, if it exists, from the directory path

cd "$currentDirectory"
source "build/compiler/compilerFunctions"

anyFilesChanged=false # Global anyFilesChanged tracks if any files are changed. If so we recompiling a devel.tar.gz.
declare -a filesThatHaveChanged # Create an array to hold the names of the files that have changed

recursiveCompiling(){ # Recursive function for code compiling
	sourceLocation=$1 # Set sourceLocation as the second location

	if [ "$sourceLocation" == "typescript" ]; then # If the sourceLocation is typescript code
		fileType="ts" # Set the fileType to ts
	else
		fileType="php" # Set the fileType to php
	fi

	filesArray=$(find src/"$sourceLocation"/ -type f -name "*.$fileType") # Get all files relating to this type recursively

	codebaseChanged=false # Set codebaseChanged to false by default. If a module has been added or changed, then it will be changed to true

	for file in $filesArray; do
		if [[ "$file" != *.d.ts ]]; then # If it is not a declaration file (exists after using tsCompile once)
			fileName="${file##*$sourceLocation/}" # Remove everything before last / to clean up the file pathing
			fileChanged "$sourceLocation" "$fileName"

			if [ "$FILE_CHANGED" == "CHANGED" ]; then # If the file has been changed
				codebaseChanged=true # Change to true
				filesThatHaveChanged+=("$fileName")
			fi
		fi
	done

	if [ $codebaseChanged == true ]; then # If the codebase has been changed
		anyFilesChanged=true # Set anyFilesChanged to true since the codebase has changed

		if [ "$sourceLocation" == "typescript" ]; then # If we are compiling Typescript
			tsc --removeComments --target 'ES5' src/typescript/metis.ts --declaration --out build/metis.js
			echo "Minifying Metis compiled Javascript."
			java -jar build/compiler/jscompressor.jar --compilation_level SIMPLE --language_in ECMASCRIPT5 --language_out ECMASCRIPT5 --warning_level QUIET --js build/metis.js --js_output_file build/metis.min.js

			cp build/metis.min.js tests/chrome/ # Copy to Chrome Example App automatically
			rm build/metis.js &> /dev/null # Remove the uncompressed metis.js file

			echo "Finished compiling and minification process of Metis."
		else # If we are compiling PHP
			php -f build/compiler/php/phpCompile.php
		fi
	fi
}

echo "Compiling Metis."

recursiveCompiling "typescript" # Compile Typescript
recursiveCompiling "php" # Compile PHP

if [ $anyFilesChanged == true ]; then # If the codebase has been changed
	echo "Files that have changed:"

	for file in ${filesThatHaveChanged[@]}
	do
		echo "$file"
	done
else # If the codebase has changed
	echo "No files have changed."
fi