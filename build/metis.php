<?php 
	/*
		Copyright 2013-2014 Strobl Industries

		Licensed under the Apache License, Version 2.0 (the "License");
		 you may not use this file except in compliance with the License.
		 You may obtain a copy of the License at

			 http://www.apache.org/licenses/LICENSE-2.0

		 Unless required by applicable law or agreed to in writing, software
		 distributed under the License is distributed on an "AS IS" BASIS,
		 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
		 See the License for the specific language governing permissions and
		 limitations under the License.
	*/

class Metis{var$nodeList="";var$directoryHostingMetis="";function __construct(){$DB=$this->metisInit();$this->nodeList=$DB[0];$this->directoryHostingMetis=$DB[1];}function fileHashing($aB){$A=preg_replace('/[^a-z0-9]/',"",$aB);$bB=substr($A,0,10);$z='$6$rounds=100000$'.$bB."$";$cB=strlen($z);$dB=substr(str_replace(array("/","\"",'"'),"",crypt(sha1(md5($A)),$z)),$cB);return substr($dB,1,28);}function navigateToLocalMetisData($L=null){$U=$this->directoryHostingMetis;$ZB=getcwd();if($U!==null){chdir($U);}chdir("Metis");chdir("data");if(isset($L)&&$L!==null){if(is_dir($L)==false){mkdir($L);}chdir($L);}return$ZB;}function fileIOArrayMerger(array$YB){$Z=array();foreach($YB as$f){$UB=array_keys($f);foreach($UB as$A){if(is_null($Z[$A])){$Z[$A]=$f[$A];}elseif(is_float($Z[$A])){if(is_array($f[$A])){$Z[$A]=$f[$A];}}}}return$Z;}function fileActionHandler($I,$B,$E,array$N=null){$C=$this->nodeList;if(isset($C["error"])==false){$M=array();$e=getcwd();$D=$this->nodeDataParser($I);if(gettype($B)=="string"){$B=(array)$B;}foreach($D as$J=>$FB){if($this->nodeInfo($J,"Node Type")=="group"){$GB=true;if(gettype($FB)=="array"){$i=$FB;}else{$i=$this->nodeInfo($J,"group-nodes");}}else{$GB=false;$i=array($J);}foreach($i as$Q){if($GB==true){$g=$C[$J];}else{$g=$C;}$VB=$this->nodeInfo($Q,"Node Type",$g);$L=$this->nodeInfo($Q,"Preferential Location",$g);if(($VB=="local")&&($L!=="backup")){$rB=$this->navigateToLocalMetisData($L);foreach($B as$R){$A=$this->fileHashing($R);$G="";if(($E=="r")||($E=="a")){$G=file_get_contents($A.".json");if($G!==false){$G=$this->decodeJsonFile($G);}else{$G=array("error"=>2.05);}}if(($E=="w")||($E=="a")){if(($E=="a")&&(isset($G["error"])==false)){$X=array_replace_recursive($G,$N);$G=$X;}else{$X=$N;$G=array("success"=>"0.00");}$X=json_encode($X);$W=fopen($A.".json","w+");fwrite($W,$X);fclose($W);touch($A.".json");}else if($E=="e"){$G=array("status"=>file_exists($A.".json"));}else if($E=="d"){unlink($A.".json");$G=array("success"=>"0.00");}$M=$this->fileIOArrayMerger(array($M,array($R=>$G)));if(($E=="r")&&(isset($G["error"])==false)){unset($B[$R]);if(count($B)==0){break 3;}}}chdir($e);}else{$u=$this->nodeInfo($Q,"Address",$g);$Y=array();$Y["nodeData"]=$L;$Y["action"]=$E;$Y["files"]=$B;if($N!==null){$Y["contentOrDestinationNodes"]=$N;}$b=json_encode($Y);$WB=$this->http_request($u,$b);$IB=$this->decodeJsonFile($WB);foreach($IB as$A=>$XB){if(gettype($XB)=="array"){unset($B[$A]);}}$M=$this->fileIOArrayMerger(array($M,$IB));}}}if($E!=="r"){$qB=$this->backupQueuer($D,$B,$E);}}else{$M=array("error"=>1.01);}if(is_float($M)){$M=array("error"=>$M);}return json_encode($M);}function createJsonFile($D,$B,array$N){return$this->fileActionHandler($D,$B,"w",$N);}function decodeJsonFile($fB){$w=json_decode($fB,true);if(is_array($w)==false){$w=array("error"=>2.06);}return$w;}function fileExists($I,$B){return$this->fileActionHandler($I,$B,"e");}function readJsonFile($D,$B){return$this->fileActionHandler($D,$B,"r");}function updateJsonFile($D,$B,array$N,$nB=true){if($nB==false){$KB="w";}else{$KB="a";}return$this->fileActionHandler($D,$B,$KB,$N);}function deleteJsonFile($D,$B){return$this->fileActionHandler($D,$B,"d");}function replicator($I,$oB,$B){if(gettype($B)=="string"){$B=(array)$B;}foreach($B as$R){$k=$this->readJsonFile($I,array($R));if(gettype($k)=="string"){$pB=$this->decodeJsonFile($k);foreach($oB as$TB){$sB=$this->createJsonFile($TB,array($R),$pB);}}else{return$k;}}return"0.00";}function backupQueuer(array$mB,array$B,$E){$C=$this->nodeList;$lB=$this->navigateToLocalMetisData("backup");$O=file_get_contents($this->fileHashing("backup-queue").".json");$hB=md5($O);if((strlen(trim($O))>2)||($O!==false)){$K=$this->decodeJsonFile($O);}else{$K=array();}$h=array();foreach($mB as$J=>$BB){if(isset($C[$J]["Backup Data"])){if($C[$J]["Backup Data"]["Enabled"]==true){$h[]=$J;}}else{if($this->nodeInfo($J,"Node Type")=="group"){if(gettype($BB)=="array"){$H=$BB;}else{$H=$this->nodeInfo($J,"group-nodes");}foreach($H as$n){if(isset($H[$n]["Backup Data"])){if($H[$n]["Backup Data"]["Enabled"]==true){$h[]=$J."#".$n;}}}}}if(count($h)>0){foreach($h as$P){if(gettype($K[$P])!=="array"){$K[$P]=array();}foreach($B as$A){if(isset($K[$P][$A])){$gB=$K[$P][$A];$m=$gB["action"];if($m!==$E){if((($m=="w")||($m=="a"))&&($E=="d")){$K[$P][$A]["action"]=$E;}}}else{$K[$P][$A]=array();$K[$P][$A]["action"]=$E;}}}}}$O=json_encode($K);$iB=md5($O);if($hB!==$iB){$A=$this->fileHashing("backup-queue");$W=fopen($A.".json","w+");fwrite($W,$O);fclose($W);touch($A.".json");}chdir($lB);}function metisInit(){$r=$_SERVER['DOCUMENT_ROOT'];$e=getcwd();$c=null;$T=null;$_=false;while($_!==true){if($T!==null){chdir($T);}$c=getcwd();if(is_dir("Metis")==true){$_=true;break;}else{if($c!==$_SERVER['DOCUMENT_ROOT']){if($T==null){$T="../";}else{$T=$T."../";}}}chdir($e);}if($r!==""){chdir($r);$jB=getcwd();$U=str_replace($r,$jB,$c);}else{$U=$c;}chdir($U);$C=$this->decodeJsonFile(file_get_contents("Metis/nodeList.json"));if(isset($C["error"])){$C=array("error"=>1.01);}chdir($e);return array($C,$U);}function http_request($u,$b){$F=curl_init();curl_setopt($F,CURLOPT_CUSTOMREQUEST,"POST");curl_setopt($F,CURLOPT_CONNECTTIMEOUT,15);curl_setopt($F,CURLOPT_FAILONERROR,true);curl_setopt($F,CURLOPT_FOLLOWLOCATION,false);curl_setopt($F,CURLOPT_MAXREDIRS,1);curl_setopt($F,CURLOPT_RETURNTRANSFER,true);curl_setopt($F,CURLOPT_SSL_VERIFYPEER,false);$kB=array("Content-length: ".strlen($b));curl_setopt($F,CURLOPT_HTTPHEADER,$kB);curl_setopt($F,CURLOPT_URL,$u."/callback.php");curl_setopt($F,CURLOPT_POSTFIELDS,$b);$eB=curl_exec($F);$y=curl_error($F);curl_close($F);if($y==0){return$eB;}else{$QB=array("3"=>"URL_MALFORMAT","7"=>"COULDNT_CONNECT","18"=>"PARTIAL_FILE","47"=>"TOO_MANY_REDIRECTS","63"=>"FILESIZE_EXCEEDED","67"=>"LOGIN_DENIED");$MB=settype($y,"string");return$QB[$MB];}}function nodeDataParser($I){$D=array();if(gettype($I)=="string"){if(strpos($I,"|")!==false){$x=explode("|",$I);}else{$x=array($I);}foreach($x as$t){if(strpos($t,"#")!==false){$AB=explode("#",$t);$CB=$AB[0];$H=$AB[1];if(strpos($H,",")!==false){$D[$CB]=explode(",",$H);}else{$D[$CB]=array($H);}}else{$D[$t]=null;}}}else if(gettype($D)=="array"){$D=$I;}else{$D[]=(array)$I;}return$D;}function nodeInfo($p,$EB,$JB=null){if($JB==null){$C=$this->nodeList;}else{$C=$JB;}if($C[$p]!==null){if($EB!=="group-nodes"){$o=$C[$p][$EB];if(isset($o)&&(is_null($o)==false)){return$o;}else{return 1.03;}}else{$H=array_keys($C[$p]);$H=array_values(array_diff($H,array("Backup Data","Node Type")));return$H;}}else{return 1.02;}}function mysqlToMetis($j,$Q,array$V){$C=$this->nodeList;if(is_object($j)){if($C!==1.01){if($C[$Q]!==null){$RB=$V["debug"];$HB=$V["filePrefix"];$PB=$V["includePrimaryFieldInFile"];$d=$V["table"];$S=$V["primaryField"];if(is_string($d)==true){$SB=mysqli_query($j,"SHOW COLUMNS FROM ".$d);$LB=mysqli_query($j,"SELECT * FROM ".$d);$s=array();while($OB=mysqli_fetch_array($SB)){$s[]=$OB[0];}if($S==null){$S=$s[0];}while($q=mysqli_fetch_array($LB)){$l=array();if($HB!==null){$a=$HB;}else{$a=$d;}$a=$a."_".$q[$S];if($PB==true){$l[$S]=$q[$S];}foreach($s as$v){if($v!==$S){$l[$v]=$q[$v];}}$NB=$this->createJsonFile($Q,array($a),$l);if($RB==true){print"We attempted to create ".$a." on Node #".$Q." and received the following response: ".$NB."<br />";}}return"0.00";}else{return 5.01;}}else{return 1.02;}}else{return 1.01;}}else{return 1.06;}}}
?>