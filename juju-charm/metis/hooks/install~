#!/bin/bash
set -e # If any command fails, stop execution.

installMetis(){ #Function to pull and install Metis
    # Clone the git repository
    echo "Cloning Metis git repository (only master branch)."
	mkdir -p /tmp/metis
    git clone --branch master git@github.com:StroblIndustries/Metis.git /var/www/

    # Remove unnecessary files from cloned repository
    cd /var/www/Metis/
    rm -rf /juju-charm /php /typescript /builders stable.zip # Remove the juju-charm, php, typescript, builder directories and stable.zip
}

apt-get install -y git unzip wget

metisVersionUrl="https://github.com/StroblIndustries/Metis/raw/master/VERSION.txt" # Define the Metis VERSION to download

wget "$metisVersionUrl" -O /tmp/metisVersion.txt

newestMetisVersion=$(</tmp/metisVersion.txt) # Get the newest Metis version

# Check for existing installs
echo "Checking for existing Metis installs"

if [ -f /var/www/Metis/metis.php ]; then #If Metis is already installed
	currentMetisVersion=$(</var/www/Metis/VERSION.txt) # Get the current Metis version that is already installed

	if [ "$newestMetisVersion" != "$currentMetisVersion" ]; then # If the current version of Metis is not the latest
		echo "Found an existing but outdated Metis install. Updating now."

		cp /var/www/Metis/nodeList.json /tmp/ # Copy nodeList.json
		mv -r /var/www/Metis/data /tmp/ # Copy over existing data
		rm -rf /var/www/Metis # Uninstall Metis

		installMetis # Reinstall Metis

		# Re-install any old data
		echo "Copying over old Metis config and data"
		mv -f /tmp/nodeList.json /var/www/Metis/ # Copy over old nodeList.json
		mv -rf /tmp/data /var/www/Metis # Copy over Metis data folder
	else
		echo "Found an existing and up-to-date Metis install. Doing nothing."
	fi
else #If Metis is NOT already installed
	echo "Found no Metis install. Doing fresh-install run."

	# Dependency Checking (No sense in re-installing dependencies)

	echo "Doing some dependency checking."

	preferredEngine=$(config-get engine)

	if [ "$preferredEngine" == "nginx" ]; then # If engine is nginx
		apt-get install -y nginx php5 php5-fpm php5-curl
	elif [ "$preferredEngine" == "apache2" ]; then #If engine is apache(2)
		apt-get install -y apache2 php5-cgi curl libapache2-mod-php5 php5-cli php5-curl
	fi

	# End of Dependency Checking

	mkdir -p /var/www/
	chmod -R 1777 /var/www/

	installMetis #Install Metis (fresh install)
fi

rm -f /tmp/metisVersion.txt #Removing metisVersion.txt
echo "Metis is done installing / updating."